<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>onePOS Quiz â€” Admin</title>
  <style>
    :root {
      --bg: #f6f7f9;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #f0f2f5;
      --blue: #0ea5e9;
      --green: #16a34a;
      --red: #ef4444;
      --yellow: #f59e0b;
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 24px; font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif; color: var(--text); background: var(--bg); }
    .wrap { max-width: 1200px; margin: 0 auto; }
    h1 { margin: 0 0 16px; font-size: 40px; letter-spacing: -0.02em; }
    .card { background: var(--card); border-radius: 16px; padding: 16px 18px; box-shadow: 0 10px 25px rgba(0,0,0,.08); }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input, button, textarea, select { font: inherit; border-radius: 10px; padding: 10px 12px; border: 1px solid #e5e7eb; background: #fff; color: var(--text); }
    input[type="date"] { min-width: 190px; }
    textarea { min-height: 80px; resize: vertical; }
    button { cursor: pointer; box-shadow: 0 8px 18px rgba(0,0,0,.06); }
    button:hover { transform: translateY(-1px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .primary { background: var(--blue); color: #fff; border: none; }
    .secondary { background: #e5e7eb; color: var(--text); }
    .success { background: var(--green); color: #fff; border: none; }
    .danger { background: var(--red); color: #fff; border: none; }
    .warning { background: var(--yellow); color: #fff; border: none; }
    .meta { color: var(--muted); font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid #e5e7eb; }
    th { color: #374151; font-weight: 700; }
    .controls { margin-left: auto; display: flex; gap: 8px; align-items: center; }
    .pagerBtn[disabled] { opacity: .45; cursor: not-allowed; }
    #errorBox { display:none; margin-top:10px; padding:10px 12px; border-radius:10px; background:#fef2f2; color:#991b1b; border:1px solid #fee2e2; }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 1000; }
    .modal { width: min(920px, 96vw); max-height: 90vh; overflow: auto; background: #fff; border-radius: 16px; padding: 18px 20px; box-shadow: 0 20px 50px rgba(0,0,0,.25); }
    .modal .top { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid #e5e7eb; color:#374151; }
    .pill { display:inline-flex; padding:3px 8px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid transparent; }
    .pill.ok { background:#ecfdf5; color:var(--green); border-color:#d1fae5; }
    .pill.bad { background:#fef2f2; color:var(--red); border-color:#fee2e2; }
    .qbox { border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin-top:10px; }
    .qtitle { margin:0 0 8px; font-weight:700; }
    .muted { color:#6b7280; }
    .closeBtn { background:#e5e7eb; }
    .headerRow { display:flex; gap:10px; align-items:center; flex-wrap: wrap; margin-top: 8px; }

    /* Toggle back pill */
    .admin-link {
      position: fixed; top: 16px; right: 16px; z-index: 9999;
      display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 999px;
      background: rgba(15, 23, 42, 0.06); backdrop-filter: blur(6px);
      color: #000; text-decoration: none; font: 600 12px/1 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; letter-spacing: .2px;
      box-shadow: 0 6px 18px rgba(0,0,0,.08); border: 1px solid rgba(15, 23, 42, 0.08); opacity: .65; transition: opacity .15s, transform .15s, background .15s;
    }
    .admin-link:hover, .admin-link:focus-visible { opacity: 1; transform: translateY(-1px); background: rgba(14, 165, 233, 0.12); outline: none; }
    .admin-dot { order: 2; width: 6px; height: 6px; border-radius: 999px; background: #0ea5e9; }
    @media (prefers-color-scheme: dark) { .admin-link { background: rgba(255,255,255,.06); color: #fff; border-color: rgba(255,255,255,.10); } }
    @media print { .admin-link { display: none !important; } }

    /* Filter dropdown */
    .filter { position: relative; }
    #quizFilterBtn {
      font: inherit; border-radius: 10px; padding: 10px 12px; border: 1px solid #e5e7eb; background: #fff; color: var(--text);
      box-shadow: 0 8px 18px rgba(0,0,0,.06); cursor: pointer; display: inline-flex; align-items: center; gap: 6px; line-height: 1.4; vertical-align: middle;
    }
    #quizFilterBtn:hover, #quizFilterBtn:focus-visible { outline: none; transform: translateY(-1px); background: #fff; box-shadow: 0 10px 25px rgba(0,0,0,.08); }
    #quizFilterBtn .caret { display: inline-block; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #6b7280; transform: translateY(1px); }
    #quizMenu {
      position: absolute; top: calc(100% + 6px); left: 0; z-index: 1000; min-width: 260px; max-height: 280px; overflow: auto; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 12px 28px rgba(0,0,0,.12); padding: 8px; display: none;
    }
    .quiz-opt { display: flex; align-items: flex-start; gap: 8px; padding: 6px 6px; border-radius: 8px; cursor: pointer; user-select: none; }
    .quiz-opt:hover { background: #f3f4f6; }
    .quiz-opt input[type="checkbox"] { margin-top: 2px; }
    .quiz-menu-actions { display: flex; gap: 8px; padding: 6px; border-top: 1px solid #f0f2f5; margin-top: 6px; justify-content: flex-end; }
    .btn-link { background: transparent; border: none; color: #0ea5e9; padding: 6px 8px; border-radius: 8px; cursor: pointer; box-shadow: none; }
    .btn-link:hover { background: rgba(14,165,233,.08); }

    /* Admin layout + menu */
    .admin-layout { display:flex; gap:24px; align-items:flex-start; }
    .admin-menu { width:220px; flex-shrink:0; }
    .admin-card { border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; }
    .menu-title { font-weight:700; font-size:14px; margin-bottom:8px; color:#6b7280; }
    .menu-list { list-style:none; padding:0; margin:0; min-height: 12px; }
    .menu-empty { color:#6b7280; font-size:12px; padding:6px 2px; }
    .menu-link { display:block; width:100%; text-align:left; padding:10px 12px; margin-bottom:6px; border-radius:8px; border:1px solid #e5e7eb; background:#fff; color:#111827; font:inherit; cursor:pointer; box-shadow:0 8px 18px rgba(0,0,0,.06); }
    .menu-link:hover { background:#f3f4f6; }
    .menu-link.active { background:rgba(17,24,39,.06); font-weight:600; }
    .admin-pages { flex:1; min-width:0; }
    .admin-page { display:none; }
    .admin-page.active { display:block; }

    /* Analysis UI */
    .kpi-grid { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; margin-top:12px; }
    .kpi { border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; }
    .kpi .label { font-size:12px; color:#6b7280; }
    .kpi .value { font-size:24px; font-weight:800; letter-spacing:-0.02em; margin-top:4px; }
    .kpi .sub { font-size:12px; color:#6b7280; margin-top:6px; }
    @media (max-width: 960px) { .kpi-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }

    /* Settings layout */
    .settings-row { align-items: center; gap: 10px; }

    /* Quiz Management Styles */
    .quiz-tabs { display:flex; border-bottom:1px solid #e5e7eb; margin-bottom:20px; }
    .quiz-tab { padding:12px 16px; border:none; background:none; cursor:pointer; border-bottom:2px solid transparent; font-weight:500; }
    .quiz-tab.active { border-bottom-color: var(--blue); color: var(--blue); }
    .quiz-tab-content { display: none; }
    .quiz-tab-content.active { display: block; }
    .quiz-item { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: #fff; }
    .quiz-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .quiz-actions { display: flex; gap: 8px; }
    .question-item { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 16px; background: #fff; }
    .question-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .option-input { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .option-input input[type="text"] { flex: 1; }
    .hidden { display: none !important; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .stat { text-align: center; padding: 16px; border: 1px solid #e5e7eb; border-radius: 12px; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--blue); }
    .stat-label { font-size: 14px; color: var(--muted); margin-top: 4px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dashboard</h1>

    <div class="card">
      <div class="admin-layout">
        <!-- Menu (always visible; empty until token is valid) -->
        <nav class="admin-menu admin-card" aria-label="Admin Menu">
          <div class="menu-title">Admin Menu</div>
          <ul id="menuList" class="menu-list"></ul>
          <div id="menuPlaceholder" class="menu-empty">Enter a valid admin token and click <strong>Load</strong> to unlock the menu.</div>
        </nav>

        <div class="admin-pages">
          <!-- RESULTS -->
          <section id="page-results" class="admin-page active">
            <div class="row">
              <input id="adminToken" type="password" placeholder="Admin token" />
              <input id="since" type="date" title="Show attempts on this exact date (single-day filter)" />

              <div class="filter">
                <button id="quizFilterBtn" type="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="quizMenu">
                  <span id="quizFilterLabel">All quizzes</span>
                  <span class="caret" aria-hidden="true"></span>
                </button>
                <div id="quizMenu" role="listbox" aria-multiselectable="true">
                  <div class="quiz-menu-actions">
                    <button class="btn-link" id="selectAllBtn" type="button">Select all</button>
                    <button class="btn-link" id="clearAllBtn" type="button">Clear</button>
                    <button class="btn-link" id="applyFilterBtn" type="button">Apply</button>
                  </div>
                </div>
              </div>

              <button class="primary" id="loadBtn" type="button">Load</button>
              <button class="primary" id="exportBtn" type="button" title="Export filtered results">Export</button>

              <div class="controls">
                <button class="pagerBtn" id="prevBtn" type="button" title="Previous page">â€¹ Prev</button>
                <span class="meta" id="pageInfo">Page 1 of 1</span>
                <button class="pagerBtn" id="nextBtn" type="button" title="Next page">Next â€º</button>
              </div>
            </div>

            <div id="errorBox" role="alert"></div>
            <div class="meta" id="meta" style="margin-top:8px;">&nbsp;</div>

            <table id="tbl" aria-label="Quiz attempts">
              <thead>
                <tr>
                  <th style="min-width:180px;">When</th>
                  <th>User</th>
                  <th>Score %</th>
                  <th>Correct/Total</th>
                  <th>Title</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </section>

          <!-- ANALYSIS -->
          <section id="page-analysis" class="admin-page" aria-labelledby="h-analysis">
            <h2 id="h-analysis" style="margin:0 0 8px;">Analysis</h2>
            <div class="row" style="margin-bottom:6px;">
              <span class="meta" id="analysisSummary">&nbsp;</span>
            </div>
            <div id="kpiGrid" class="kpi-grid"></div>
          </section>

          <!-- QUIZZES -->
          <section id="page-quizzes" class="admin-page">
            <h2 style="margin:0 0 8px;">Quizzes</h2>
            
            <!-- Quiz Management Tabs -->
            <div class="quiz-tabs">
              <button class="quiz-tab active" data-tab="list">All Quizzes</button>
              <button class="quiz-tab" data-tab="create">Create Quiz</button>
            </div>

            <!-- Quiz List Tab -->
            <div class="quiz-tab-content active" id="quiz-list">
              <!-- Stats Overview -->
              <div class="stats">
                <div class="stat">
                  <div class="stat-value" id="totalQuizzes">0</div>
                  <div class="stat-label">Total Quizzes</div>
                </div>
                <div class="stat">
                  <div class="stat-value" id="totalQuestions">0</div>
                  <div class="stat-label">Total Questions</div>
                </div>
                <div class="stat">
                  <div class="stat-value" id="avgQuestionsPerQuiz">0</div>
                  <div class="stat-label">Avg Questions/Quiz</div>
                </div>
              </div>

              <!-- Controls -->
              <div class="row" style="margin-bottom:16px;">
                <button class="primary" onclick="showCreateTab()">Create New Quiz</button>
                <button class="secondary" onclick="refreshQuizList()">Refresh</button>
                <span class="meta" id="quizListStatus">Loading...</span>
              </div>

              <!-- Error/Success Messages -->
              <div id="quizErrorMsg" style="display:none; color:var(--red); font-size:14px; margin-bottom:16px;"></div>
              <div id="quizSuccessMsg" style="display:none; color:var(--green); font-size:14px; margin-bottom:16px;"></div>

              <!-- Quiz List -->
              <div id="quizListContainer" style="display:grid; gap:16px;">
                <!-- Quiz items will be loaded here -->
              </div>
            </div>

            <!-- Create Quiz Tab -->
            <div class="quiz-tab-content" id="quiz-create">
              <form id="quizForm">
                <div style="margin-bottom:16px;">
                  <label style="display:block; margin-bottom:4px; font-weight:600;">Quiz ID</label>
                  <input type="text" id="quizId" placeholder="e.g., server_basics" required style="width:100%; max-width:400px;">
                  <div class="meta">Unique identifier (letters, numbers, underscores only)</div>
                </div>
                
                <div style="margin-bottom:16px;">
                  <label style="display:block; margin-bottom:4px; font-weight:600;">Quiz Title</label>
                  <input type="text" id="quizTitle" placeholder="e.g., Server Fundamentals" required style="width:100%; max-width:400px;">
                </div>
                
                <div style="margin-bottom:20px;">
                  <label style="display:block; margin-bottom:4px; font-weight:600;">Description (Optional)</label>
                  <textarea id="quizDescription" placeholder="Brief description of the quiz" style="width:100%; max-width:600px; min-height:80px; resize:vertical;"></textarea>
                </div>
                
                <h3>Questions</h3>
                <div id="questionsList">
                  <!-- Questions will be added here -->
                </div>
                
                <button type="button" onclick="addQuestion()" class="secondary" style="margin:16px 0;">Add Question</button>
                
                <div class="row" style="margin-top:20px;">
                  <button type="submit" class="primary">Save Quiz</button>
                  <button type="button" onclick="clearQuizForm()" class="secondary">Clear Form</button>
                </div>
              </form>
            </div>
          </section>

          <!-- USERS -->
          <section id="page-users" class="admin-page">
            <h2 style="margin:0 0 8px;">Users</h2>
            <p class="meta">User insights (coming soon).</p>
          </section>

          <!-- SETTINGS -->
          <section id="page-settings" class="admin-page" aria-labelledby="h-settings">
            <h2 id="h-settings" style="margin:0 0 8px;">Settings</h2>

            <div class="row settings-row">
              <div style="display:flex; flex-direction:column; gap:6px;">
                <label for="settingsPass" class="meta">Pass threshold (%)</label>
                <input id="settingsPass" type="number" min="1" max="100" step="1" placeholder="80" />
              </div>
              <button id="saveSettingsBtn" class="primary" type="button">Save</button>
              <span id="saveSettingsStatus" class="meta">&nbsp;</span>
            </div>

            <div class="row" style="margin-top:12px;">
              <button id="clearTokenBtn" type="button">Clear token</button>
            </div>
            <p class="meta" id="tokenStatus" style="margin-top:8px;">Token: not set</p>
          </section>

          <!-- LOGS -->
          <section id="page-logs" class="admin-page">
            <h2 style="margin:0 0 8px;">Logs</h2>
            <p class="meta">Audit & debug (coming soon).</p>
          </section>

          <!-- EXPORT -->
          <section id="page-export" class="admin-page">
            <h2 style="margin:0 0 8px;">Export</h2>
            <p class="meta">Exports respect the Results filters.</p>
            <div class="row"><button class="primary" id="exportPageBtn" type="button">Export</button></div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div id="backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mdTitle">
      <div class="top">
        <h2 id="mdTitle" style="margin:0;">Attempt Details</h2>
        <button id="closeModal" class="closeBtn" type="button">Close</button>
      </div>
      <div id="mdMeta" class="headerRow"></div>
      <div id="mdBody" style="margin-top:12px;"></div>
    </div>
  </div>

  <!-- Edit Quiz Modal -->
  <div id="editQuizModal" class="modal-backdrop">
    <div class="modal">
      <div class="top">
        <h2 id="editQuizModalTitle" style="margin:0;">Edit Quiz</h2>
        <button onclick="closeEditQuizModal()" class="closeBtn" type="button">Ã—</button>
      </div>
      <form id="editQuizForm">
        <input type="hidden" id="editQuizOriginalId">
        
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:4px; font-weight:600;">Quiz ID</label>
          <input type="text" id="editQuizId" required style="width:100%;">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block; margin-bottom:4px; font-weight:600;">Quiz Title</label>
          <input type="text" id="editQuizTitle" required style="width:100%;">
        </div>
        
        <div style="margin-bottom:20px;">
          <label style="display:block; margin-bottom:4px; font-weight:600;">Description</label>
          <textarea id="editQuizDescription" style="width:100%; min-height:80px; resize:vertical;"></textarea>
        </div>
        
        <h3>Questions</h3>
        <div id="editQuestionsList">
          <!-- Questions will be loaded here -->
        </div>
        
        <button type="button" onclick="addEditQuestion()" class="secondary" style="margin:16px 0;">Add Question</button>
        
        <div class="row" style="margin-top:20px;">
          <button type="submit" class="primary">Update Quiz</button>
          <button type="button" onclick="closeEditQuizModal()" class="secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toggle back to Quiz -->
  <a href="/" class="admin-link" aria-label="Back to Quiz">
    <span class="admin-label">Quiz</span>
    <span class="admin-dot" aria-hidden="true"></span>
  </a>

  <script>
  (function(){
    const $ = (s) => document.querySelector(s);

    /* ========== Utilities ========== */
    const csvEscape = (v) => '"' + String(v ?? '').replace(/"/g,'""') + '"';
    const fmtISO = (iso) => iso || '';
    function fmtUS(iso){
      if(!iso) return '';
      const d = new Date(iso);
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const yy = String(d.getFullYear()).slice(-2);
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      const ss = String(d.getSeconds()).padStart(2,'0');
      return `${mm}/${dd}/${yy}, ${hh}:${mi}:${ss}`;
    }
    function toISODate(y, m, d){ return `${String(y)}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
    function normalizeYear2(yy){ return yy < 70 ? 2000 + yy : 1900 + yy; }
    function parseTypedDate(v){
      const m = v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/);
      if (!m) return '';
      let [ , mm, dd, yy ] = m;
      mm = parseInt(mm, 10); dd = parseInt(dd, 10);
      let year = String(yy).length === 2 ? normalizeYear2(parseInt(yy,10)) : parseInt(yy,10);
      if (mm < 1 || mm > 12 || dd < 1 || dd > 31 || year < 1900 || year > 2099) return '';
      return toISODate(year, mm, dd);
    }

    /* Helper for concurrency limiting */
    async function mapWithConcurrency(array, asyncFn, concurrency = 5) {
      const results = [];
      for (let i = 0; i < array.length; i += concurrency) {
        const batch = array.slice(i, i + concurrency);
        const batchResults = await Promise.all(batch.map(asyncFn));
        results.push(...batchResults);
      }
      return results;
    }

    /* Local calendar helpers (fix UTC bleed) */
    function getSelectedDateISO(){
      const el = document.getElementById('since');
      if (!el) return '';
      const v = (el.value || '').trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
      const typed = parseTypedDate(v);
      return typed || '';
    }
    const dayKeyLocal = (iso) => {
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return '';
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`; // local day
    };

    function mean(arr){ if(!arr.length) return null; const s = arr.reduce((a,b)=>a+(+b||0),0); return s/arr.length; }
    function median(arr){ if(!arr.length) return null; const a = arr.slice().sort((x,y)=>x-y); const mid = Math.floor(a.length/2); return a.length%2?a[mid]:(a[mid-1]+a[mid])/2; }
    function quantile(arr, q){ if(!arr.length) return null; const a = arr.slice().sort((x,y)=>x-y); const pos = (a.length-1)*q; const lo=Math.floor(pos), hi=Math.ceil(pos); if(lo===hi) return a[lo]; return a[lo]+(a[hi]-a[lo])*(pos-lo); }

    /* ========== Settings (pass threshold) ========== */
    const SETTINGS_KEY_PASS = 'onepos_pass_threshold_pct';
    function loadPassThreshold(){
      let v = parseInt(localStorage.getItem(SETTINGS_KEY_PASS) || '80', 10);
      if (!Number.isFinite(v) || v < 1 || v > 100) v = 80;
      const inp = $('#settingsPass'); if (inp) inp.value = v;
      STATE.passThresholdPct = v;
    }
    function savePassThreshold(){
      const inp = $('#settingsPass'), status = $('#saveSettingsStatus');
      let v = parseInt((inp?.value || '').trim(), 10);
      if (!Number.isFinite(v)) { if(status) status.textContent = 'Enter a number 1â€“100.'; return; }
      v = Math.max(1, Math.min(100, v));
      localStorage.setItem(
