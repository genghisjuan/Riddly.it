<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Quizzes</title>
  <style>
    :root {
      --bg: #f6f7f9;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #eef1f4;
      --blue: #0ea5e9;
      --green: #16a34a;
      --red: #ef4444;
      --yellow: #f59e0b;
      --purple: #8b5cf6;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:24px;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg)}
    .wrap{max-width:1200px;margin:0 auto}
    h1{margin:0 0 16px;font-size:40px;letter-spacing:-0.02em}
    .card{background:var(--card);border-radius:16px;padding:16px 18px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input,button,textarea,select{font:inherit;border-radius:10px;padding:10px 12px;border:1px solid #e5e7eb;background:#fff;color:var(--text)}
    textarea{min-height:80px;resize:vertical}
    button{cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06)}
    button:hover{transform:translateY(-1px)}
    button:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .primary{background:var(--blue);color:#fff;border:none}
    .secondary{background:#e5e7eb;color:var(--text)}
    .success{background:var(--green);color:#fff;border:none}
    .danger{background:var(--red);color:#fff;border:none}
    .warning{background:var(--yellow);color:#fff;border:none}
    .meta{color:var(--muted);font-size:12px}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{text-align:left;padding:10px 8px;border-bottom:1px solid #e5e7eb}
    th{color:#374151;font-weight:700}

    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
    .modal{width:min(920px,96vw);max-height:90vh;overflow:auto;background:#fff;border-radius:16px;padding:18px 20px;box-shadow:0 20px 50px rgba(0,0,0,.25)}
    .modal .top{display:flex;align-items:center;justify-content:space-between;gap:12px}

    /* Admin layout + nav */
    .admin-layout{display:flex;gap:24px;align-items:flex-start}
    .admin-menu{width:220px;flex-shrink:0}
    .admin-card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff}
    .menu-title{font-weight:700;font-size:14px;margin-bottom:8px;color:#6b7280}
    .menu-list{list-style:none;padding:0;margin:0}
    .menu-link{display:block;width:100%;text-align:left;padding:10px 12px;margin-bottom:6px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;color:#111827;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.06)}
    .menu-link.active{background:rgba(17,24,39,.06);font-weight:600}
    .admin-pages{flex:1;min-width:0}
    .admin-page{display:none}
    .admin-page.active{display:block}

    /* KPIs */
    .kpi-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
    .kpi{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff}
    .kpi .label{font-size:12px;color:#6b7280}
    .kpi .value{font-size:24px;font-weight:800;letter-spacing:-0.02em;margin-top:4px}

    /* Quiz Manager */
    .quiz-tabs{display:flex;border-bottom:1px solid #e5e7eb;margin-bottom:20px}
    .quiz-tab{padding:12px 16px;border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;font-weight:500}
    .quiz-tab.active{border-bottom-color:var(--blue);color:var(--blue)}
    .quiz-tab-content{display:none}
    .quiz-tab-content.active{display:block}
    .quiz-item{border:1px solid #e5e7eb;border-radius:12px;padding:16px;background:#fff}
    .quiz-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
    .quiz-actions{display:flex;gap:8px}
    .quiz-meta{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .otp-badge{background:#f3e8ff;color:#7c3aed;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600}
    .question-item{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-bottom:16px;background:#fff}
    .question-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
    .option-input{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .option-input input[type="text"]{flex:1}
    .hidden{display:none!important}

    /* OTP Manager */
    .otp-item{border:1px solid #e5e7eb;border-radius:12px;padding:16px;background:#fff;margin-bottom:12px}
    .otp-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .otp-code{font-family:monospace;font-size:18px;font-weight:700;color:var(--blue)}
    .otp-status{font-size:12px;padding:2px 8px;border-radius:12px}
    .otp-status.active{background:#ecfdf5;color:var(--green)}
    .otp-status.used{background:#fef2f2;color:var(--red)}
    .otp-status.expired{background:#fef3c7;color:#d97706}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dashboard</h1>

    <div class="card">
      <div class="admin-layout">
        <!-- Left Nav -->
        <nav class="admin-menu admin-card" aria-label="Admin Menu">
          <div class="menu-title">Admin Menu</div>
          <ul id="menuList" class="menu-list"></ul>
          <div id="menuPlaceholder" class="meta">Enter your admin token and click <strong>Load</strong> to unlock the menu.</div>
        </nav>

        <!-- Pages -->
        <div class="admin-pages">
          <!-- RESULTS -->
          <section id="page-results" class="admin-page active">
            <div class="row">
              <input id="adminToken" type="password" placeholder="Admin token" />
              <input id="since" type="date" title="Show attempts on this exact date (single-day filter)" />
              <button class="primary" id="loadBtn" type="button">Load</button>
              <button class="primary" id="exportBtn" type="button" title="Export filtered results">Export</button>
              <div class="row" style="margin-left:auto">
                <button class="secondary" id="prevBtn" type="button" title="Previous page">‹ Prev</button>
                <span class="meta" id="pageInfo">Page 1 of 1</span>
                <button class="secondary" id="nextBtn" type="button" title="Next page">Next ›</button>
              </div>
            </div>
            <div id="errorBox" class="meta" style="color:var(--red);display:none"></div>
            <div class="meta" id="meta" style="margin-top:8px;">&nbsp;</div>
            <table id="tbl" aria-label="Quiz attempts">
              <thead>
                <tr>
                  <th style="min-width:180px;">When</th>
                  <th>User</th>
                  <th>Score %</th>
                  <th>Correct/Total</th>
                  <th>Title</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </section>

          <!-- ANALYSIS -->
          <section id="page-analysis" class="admin-page">
            <h2 style="margin:0 0 8px;">Analysis</h2>
            <div class="meta" id="analysisSummary">&nbsp;</div>
            <div id="kpiGrid" class="kpi-grid"></div>
          </section>

          <!-- QUIZZES -->
          <section id="page-quizzes" class="admin-page">
            <h2 style="margin:0 0 8px;">Quizzes</h2>

            <div class="quiz-tabs">
              <button class="quiz-tab active" data-tab="list">All Quizzes</button>
              <button class="quiz-tab" data-tab="create">Create Quiz</button>
              <button class="quiz-tab" data-tab="otp">OTP Manager</button>
            </div>

            <!-- List -->
            <div id="tab-list" class="quiz-tab-content active">
              <div class="row" style="margin-bottom:16px;">
                <button class="primary" onclick="showCreateTab()">Create New Quiz</button>
                <button class="secondary" onclick="refreshQuizList()">Refresh</button>
                <button class="secondary" onclick="bulkExportQuizzes()">Export All</button>
                <span class="meta" id="quizListStatus">Loading…</span>
              </div>
              <div id="quizErrorMsg" style="display:none;color:var(--red);font-size:14px;margin-bottom:12px"></div>
              <div id="quizSuccessMsg" style="display:none;color:var(--green);font-size:14px;margin-bottom:12px"></div>
              <div id="quizListContainer" style="display:grid;gap:16px"></div>
            </div>

            <!-- Create -->
            <div id="tab-create" class="quiz-tab-content">
              <form id="quizForm">
                <div style="margin-bottom:12px">
                  <label style="display:block;margin-bottom:4px;font-weight:600">Quiz ID</label>
                  <input type="text" id="quizId" placeholder="e.g., server_basics" required style="width:100%;max-width:420px">
                  <div class="meta">Unique identifier (letters, numbers, underscores)</div>
                </div>
                <div style="margin-bottom:12px">
                  <label style="display:block;margin-bottom:4px;font-weight:600">Quiz Title</label>
                  <input type="text" id="quizTitle" placeholder="e.g., Server Fundamentals" required style="width:100%;max-width:420px">
                </div>
                <div style="margin-bottom:12px">
                  <label style="display:block;margin-bottom:4px;font-weight:600">Assign OTP (Optional)</label>
                  <div class="row">
                    <input type="text" id="quizOTP" placeholder="6-digit code" maxlength="6" style="width:200px">
                    <button type="button" class="secondary" onclick="generateOTP()">Generate</button>
                  </div>
                  <div class="meta">If set, users must enter this 6-digit code to access the quiz.</div>
                </div>
                <div style="margin-bottom:16px">
                  <label style="display:block;margin-bottom:4px;font-weight:600">Description (Optional)</label>
                  <textarea id="quizDescription" style="width:100%;max-width:640px"></textarea>
                </div>
                <h3>Questions</h3>
                <div id="questionsList"></div>
                <button type="button" class="secondary" onclick="addQuestion()" style="margin:12px 0">Add Question</button>
                <div class="row" style="margin-top:12px">
                  <button type="submit" class="primary">Save Quiz</button>
                  <button type="button" class="secondary" onclick="clearQuizForm()">Clear</button>
                </div>
              </form>
            </div>

            <!-- OTP Manager -->
            <div id="tab-otp" class="quiz-tab-content">
              <div class="row" style="margin-bottom:12px">
                <button class="primary" onclick="showCreateOTPModal()">Create New OTP</button>
                <button class="secondary" onclick="refreshOTPs()">Refresh</button>
                <span class="meta" id="otpListStatus">Loading…</span>
              </div>
              <div id="otpListContainer"></div>
            </div>
          </section>

          <!-- USERS -->
          <section id="page-users" class="admin-page"><h2>Users</h2><p class="meta">Coming soon.</p></section>
          <!-- SETTINGS -->
          <section id="page-settings" class="admin-page"><h2>Settings</h2>
            <div class="row"><label class="meta">Pass threshold (%)</label><input id="settingsPass" type="number" min="1" max="100" step="1" placeholder="80"><button id="saveSettingsBtn" class="primary" type="button">Save</button><span id="saveSettingsStatus" class="meta">&nbsp;</span></div>
            <div class="row" style="margin-top:10px"><button id="clearTokenBtn" type="button">Clear token</button><span id="tokenStatus" class="meta">Token: not set</span></div>
          </section>
          <!-- LOGS / EXPORT -->
          <section id="page-logs" class="admin-page"><h2>Logs</h2><p class="meta">Coming soon.</p></section>
          <section id="page-export" class="admin-page"><h2>Export</h2><div class="row"><button class="primary" id="exportPageBtn" type="button">Export</button></div></section>
        </div>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div id="backdrop" class="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mdTitle">
      <div class="top"><h2 id="mdTitle" style="margin:0">Attempt Details</h2><button id="closeModal" class="secondary" type="button">Close</button></div>
      <div id="mdMeta" class="meta" style="margin:8px 0"></div>
      <div id="mdBody"></div>
    </div>
  </div>

  <!-- Edit Quiz Modal -->
  <div id="editQuizModal" class="backdrop" aria-hidden="true">
    <div class="modal">
      <div class="top"><h2 style="margin:0">Edit Quiz</h2><button class="secondary" type="button" onclick="closeEditQuizModal()">×</button></div>
      <form id="editQuizForm">
        <input type="hidden" id="editQuizOriginalId">
        <div style="margin-bottom:12px"><label style="display:block;margin-bottom:4px;font-weight:600">Quiz ID</label><input type="text" id="editQuizId" required style="width:100%"></div>
        <div style="margin-bottom:12px"><label style="display:block;margin-bottom:4px;font-weight:600">Quiz Title</label><input type="text" id="editQuizTitle" required style="width:100%"></div>
        <div style="margin-bottom:12px">
          <label style="display:block;margin-bottom:4px;font-weight:600">OTP Code</label>
          <div class="row"><input type="text" id="editQuizOTP" maxlength="6" style="width:200px"><button type="button" class="secondary" onclick="generateEditOTP()">Generate</button></div>
          <div class="meta">6-digit code; leave blank for public quiz.</div>
        </div>
        <div style="margin-bottom:12px"><label style="display:block;margin-bottom:4px;font-weight:600">Description</label><textarea id="editQuizDescription" style="width:100%"></textarea></div>
        <h3>Questions</h3>
        <div id="editQuestionsList"></div>
        <button type="button" class="secondary" onclick="addEditQuestion()" style="margin:12px 0">Add Question</button>
        <div class="row" style="margin-top:12px"><button type="submit" class="primary">Update Quiz</button><button type="button" class="secondary" onclick="closeEditQuizModal()">Cancel</button></div>
      </form>
    </div>
  </div>

  <!-- Create OTP Modal -->
  <div id="createOTPModal" class="backdrop" aria-hidden="true">
    <div class="modal">
      <div class="top"><h2 style="margin:0">Create OTP</h2><button class="secondary" type="button" onclick="closeCreateOTPModal()">×</button></div>
      <form id="createOTPForm">
        <div style="margin-bottom:12px"><label style="display:block;margin-bottom:4px;font-weight:600">OTP Code</label><div class="row"><input type="text" id="newOTPCode" maxlength="6" placeholder="6 digits" style="width:200px"><button type="button" class="secondary" onclick="generateNewOTP()">Generate</button></div></div>
        <div style="margin-bottom:12px"><label style="display:block;margin-bottom:4px;font-weight:600">Assign to Quiz</label><select id="newOTPQuiz" style="width:100%"><option value="">Select a quiz…</option></select></div>
        <div style="margin-bottom:12px"><label style="display:block;margin-bottom:4px;font-weight:600">Title/Description</label><input type="text" id="newOTPTitle" placeholder="e.g., Training Cohort A" style="width:100%"></div>
        <div class="row"><button type="submit" class="primary">Create OTP</button><button type="button" class="secondary" onclick="closeCreateOTPModal()">Cancel</button></div>
      </form>
    </div>
  </div>

  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);

    /* ===== Utils ===== */
    const csvEscape = (v)=> '"' + String(v ?? '').replace(/"/g,'""') + '"';
    const isValidOTP = (v)=> /^\d{6}$/.test(String(v||'').trim());
    const fmtUS = (iso)=>{ if(!iso) return ''; const d=new Date(iso); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); const yy=d.getFullYear(); const hh=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0'); return `${mm}/${dd}/${yy} ${hh}:${mi}`; };

    /* ===== State ===== */
    const STATE = { tokenValid:false, page:1, pageSize:20, totalPages:1, lastResults:[], passThresholdPct:80 };
    let quizzes = []; // in-memory cache
    let otps = [];    // in-memory OTPs
    let editingQuiz = null; let questionCounter = 0; let CURRENT_TOKEN='';

    /* ===== Nav ===== */
    function populateMenu(){ if(STATE.menuPopulated) return; const list = $('#menuList'); const ph=$('#menuPlaceholder'); list.innerHTML=`
      <li><button class="menu-link active" data-page="page-results">Results</button></li>
      <li><button class="menu-link" data-page="page-analysis">Analysis</button></li>
      <li><button class="menu-link" data-page="page-quizzes">Quizzes</button></li>
      <li><button class="menu-link" data-page="page-users">Users</button></li>
      <li><button class="menu-link" data-page="page-settings">Settings</button></li>
      <li><button class="menu-link" data-page="page-logs">Logs</button></li>
      <li><button class="menu-link" data-page="page-export">Export</button></li>`; ph.style.display='none'; STATE.menuPopulated=true; }
    function clearMenu(){ $('#menuList').innerHTML=''; $('#menuPlaceholder').style.display='block'; STATE.menuPopulated=false; setActive('page-results'); }
    function setActive(id){ document.querySelectorAll('.admin-page').forEach(sec=>sec.classList.toggle('active',sec.id===id)); document.querySelectorAll('.menu-link').forEach(a=>a.classList.toggle('active',a.getAttribute('data-page')===id)); if(id==='page-quizzes') initQuizManager(); if(id==='page-analysis') runAnalysis(); }
    document.addEventListener('click',(e)=>{ const b = e.target.closest('.menu-link'); if(!b) return; setActive(b.getAttribute('data-page')); });

    /* ===== Errors ===== */
    function showError(msg){ const box=$('#errorBox'); box.textContent=msg; box.style.display='block'; }
    function clearError(){ const box=$('#errorBox'); box.textContent=''; box.style.display='none'; }

    /* ===== Results (stub fetchers) ===== */
    async function fetchPageSummaries({page,pageSize,token}){
      // Demo stub: return empty
      return { ok:true, page, page_size:pageSize, total_pages:1, results:[] };
    }
    async function fetchAllSummaries(token){ const first = await fetchPageSummaries({page:1,pageSize:200,token}); return { all:first.results, since:'' }; }
    async function fetchAttemptDetail(id){ return { id, title:'Example Quiz', user_name:'User', received_at:new Date().toISOString(), scorePct:100, correct:10, total:10, rows:[] }; }

    function renderTableRows(rows){ const tbody = $('#tbl tbody'); tbody.innerHTML=''; rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${fmtUS(r.received_at)}</td><td>${r.user_name||''}</td><td>${r.scorePct??''}</td><td>${(r.correct??'')}/${(r.total??'')}</td><td>${r.title||''}</td><td><button class="primary detailsBtn" data-id="${r.id}">View</button></td>`; tbody.appendChild(tr); }); document.querySelectorAll('.detailsBtn').forEach(b=>b.addEventListener('click',()=>openDetails(b.getAttribute('data-id')))); }

    async function load(page){ clearError(); const token = ($('#adminToken')?.value||'').trim(); CURRENT_TOKEN=token; try{ const json = await fetchPageSummaries({page:page||STATE.page,pageSize:STATE.pageSize,token}); if(!json.ok) throw new Error('Load failed'); STATE.tokenValid=true; populateMenu(); STATE.page=json.page; STATE.pageSize=json.page_size; STATE.totalPages=json.total_pages; STATE.lastResults = json.results||[]; renderTableRows(STATE.lastResults); $('#meta').textContent=`${STATE.lastResults.length} attempt(s)`; $('#pageInfo').textContent=`Page ${STATE.page} of ${STATE.totalPages}`; }catch(e){ STATE.tokenValid=false; clearMenu(); showError('Failed to load results.'); }}

    async function openDetails(id){ const a = await fetchAttemptDetail(id); $('#mdTitle').textContent=a.title||'Attempt'; $('#mdMeta').textContent=`User: ${a.user_name||'—'} • When: ${fmtUS(a.received_at)} • Score: ${a.scorePct??''}%`; $('#mdBody').innerHTML='<div class="meta">Per-question details not available in demo.</div>'; showModal(true); }
    function showModal(on){ const bd=$('#backdrop'); bd.style.display = on?'flex':'none'; bd.setAttribute('aria-hidden', on?'false':'true'); }

    /* ===== Analysis (demo) ===== */
    function runAnalysis(){ const grid=$('#kpiGrid'); grid.innerHTML = `<div class="kpi"><div class="label">Completions</div><div class="value">${STATE.lastResults.length}</div></div>`; $('#analysisSummary').textContent = `${STATE.lastResults.length} attempt(s)`; }

    /* ===== Quiz Manager ===== */
    function initQuizManager(){ setupQuizTabs(); setupQuizFormHandlers(); refreshQuizList(); refreshOTPs(); }

    function setupQuizTabs(){ document.querySelectorAll('.quiz-tab').forEach(t=>{ t.addEventListener('click', function(){ document.querySelectorAll('.quiz-tab').forEach(x=>x.classList.remove('active')); this.classList.add('active'); document.querySelectorAll('.quiz-tab-content').forEach(c=>c.classList.remove('active')); const tab = this.dataset.tab; $('#tab-'+tab).classList.add('active'); }); }); }

    function setupQuizFormHandlers(){ $('#quizForm')?.addEventListener('submit', handleCreateQuiz); $('#editQuizForm')?.addEventListener('submit', handleEditQuiz); $('#createOTPForm')?.addEventListener('submit', handleCreateOTP); }

    async function refreshQuizList(){ showQuizMessage('Loading quizzes…','status'); // demo data if empty
      if(!quizzes.length){ quizzes = [ { test_id:'quiz_test', title:'The onePOS Operations Mastery Quiz', description:'10 questions', otp:'123456', questions:[{id:'q1',type:'true_false',text:'Is POS fun?',answer:true}] }, { test_id:'ops_mastery', title:'Quiz 2', description:'20 questions', otp:'789012', questions:[{id:'q1',type:'multiple_choice',text:'Pick one',options:['A','B','C'],answer:'A'}] } ]; }
      renderQuizList(); showQuizMessage(`${quizzes.length} quizzes loaded`,'success'); }

    function renderQuizList(){ const c=$('#quizListContainer'); if(!quizzes.length){ c.innerHTML='<div class="meta">No quizzes yet. Create one!</div>'; return; } c.innerHTML = quizzes.map(q=>`
      <div class="quiz-item">
        <div class="quiz-header">
          <div>
            <h3 style="margin:0 0 4px">${q.title||'Untitled Quiz'}</h3>
            <div class="quiz-meta"><span class="meta">ID: ${q.test_id} • ${q.questions?.length||0} questions</span> ${q.otp?`<span class="otp-badge">OTP: ${q.otp}</span>`:''}</div>
            ${q.description?`<div class="meta" style="margin-top:8px">${q.description}</div>`:''}
          </div>
          <div class="quiz-actions">
            <button class="secondary" onclick="editQuiz('${q.test_id}')">Edit</button>
            <button class="warning" onclick="duplicateQuiz('${q.test_id}')">Duplicate</button>
            <button class="danger" onclick="deleteQuiz('${q.test_id}')">Delete</button>
          </div>
        </div>
      </div>`).join(''); }

    function showQuizMessage(msg,type){ const err=$('#quizErrorMsg'), ok=$('#quizSuccessMsg'), status=$('#quizListStatus'); if(err) err.style.display='none'; if(ok) ok.style.display='none'; if(type==='error'&&err){ err.textContent=msg; err.style.display='block'; } else if(type==='success'&&ok){ ok.textContent=msg; ok.style.display='block'; setTimeout(()=>ok.style.display='none',2500);} else if(type==='status'&&status){ status.textContent=msg; } }

    /* ===== Create / Edit helpers ===== */
    window.showCreateTab = ()=> document.querySelector('.quiz-tab[data-tab="create"]').click();
    window.addQuestion = ()=>{ const container=$('#questionsList'); const id='q'+(++questionCounter); container.insertAdjacentHTML('beforeend', createQuestionHTML(id,'',{type:'multiple_choice',text:'',options:['','','',''],answer:'',explanation:''})); };
    window.addEditQuestion = ()=>{ const container=$('#editQuestionsList'); const id='q'+Date.now(); container.insertAdjacentHTML('beforeend', createQuestionHTML(id,'edit',{type:'multiple_choice',text:'',options:['','','',''],answer:'',explanation:''})); };

    function createQuestionHTML(questionId,prefix='',q={}){ const base=prefix+questionId; const num = questionId.replace(/\D/g,'')||''; return `
      <div class="question-item" data-question-id="${questionId}">
        <div class="question-header"><h4 style="margin:0">Question ${num}</h4><button type="button" class="danger" style="font-size:12px" onclick="removeQuestion('${questionId}','${prefix}')">Remove</button></div>
        <div style="margin-bottom:10px"><label style="display:block;margin-bottom:4px;font-weight:600">Question Type</label>
          <select onchange="updateQuestionType('${base}',this.value)" style="width:200px">
            <option value="multiple_choice" ${q.type==='multiple_choice'?'selected':''}>Multiple Choice</option>
            <option value="true_false" ${q.type==='true_false'?'selected':''}>True/False</option>
            <option value="short_answer" ${q.type==='short_answer'?'selected':''}>Short Answer</option>
          </select>
        </div>
        <div style="margin-bottom:10px"><label style="display:block;margin-bottom:4px;font-weight:600">Question Text</label>
          <textarea id="${base}Text" style="width:100%">${q.text||''}</textarea></div>
        <div id="${base}Options" class="${q.type==='short_answer'?'hidden':''}" style="margin-bottom:10px">
          <label style="display:block;margin-bottom:6px;font-weight:600">Answer Options</label>
          <div id="${base}OptionsList">${q.type==='true_false'?createTrueFalseOptions(base,q.answer):createMultipleChoiceOptions(base,q.options||['','','',''],q.answer)}</div>
          ${q.type==='multiple_choice'?`<button type="button" class="secondary" onclick="addOption('${base}')">Add Option</button>`:''}
        </div>
        <div id="${base}ShortAnswer" class="${q.type!=='short_answer'?'hidden':''}" style="margin-bottom:10px">
          <label style="display:block;margin-bottom:4px;font-weight:600">Correct Answer(s)</label>
          <input type="text" id="${base}Answer" value="${Array.isArray(q.answer)?q.answer.join(' | '):(q.answer||'')}" placeholder="Separate multiple answers with |" style="width:100%">
        </div>
        <div style="margin-bottom:10px"><label style="display:block;margin-bottom:4px;font-weight:600">Explanation (Optional)</label>
          <textarea id="${base}Explanation" style="width:100%">${q.explanation||''}</textarea></div>
      </div>`; }

    function createMultipleChoiceOptions(base,options=['','','',''],correct=''){ return options.map((opt,i)=>`<div class="option-input"><input type="radio" name="${base}Answer" value="${opt}" ${opt===correct?'checked':''}><input type="text" placeholder="Option ${i+1}" value="${opt}" onchange="updateOptionValue('${base}',${i},this.value)" style="flex:1">${options.length>2?`<button type="button" class="danger" style="font-size:12px" onclick="removeOption('${base}',${i})">Remove</button>`:''}</div>`).join(''); }
    function createTrueFalseOptions(base,correct=''){ return `<div class="option-input"><input type="radio" name="${base}Answer" value="true" ${(correct===true||correct==='true')?'checked':''}><span>True</span></div><div class="option-input"><input type="radio" name="${base}Answer" value="false" ${(correct===false||correct==='false')?'checked':''}><span>False</span></div>`; }

    window.updateQuestionType = function(base,type){ const opt=$('#'+base+'Options'), sa=$('#'+base+'ShortAnswer'), list=$('#'+base+'OptionsList'); if(type==='short_answer'){ opt.classList.add('hidden'); sa.classList.remove('hidden'); } else { opt.classList.remove('hidden'); sa.classList.add('hidden'); list.innerHTML = (type==='true_false')?createTrueFalseOptions(base):createMultipleChoiceOptions(base); } };
    window.removeQuestion = (qid,prefix='')=>{ const el=document.querySelector(`[data-question-id="${qid}"]`); if(el) el.remove(); };
    window.addOption = (base)=>{ const list=$('#'+base+'OptionsList'); const idx=list.querySelectorAll('.option-input').length; list.insertAdjacentHTML('beforeend', `<div class="option-input"><input type="radio" name="${base}Answer" value=""><input type="text" placeholder="Option ${idx+1}" onchange="updateOptionValue('${base}',${idx},this.value)" style="flex:1"><button type="button" class="danger" style="font-size:12px" onclick="removeOption('${base}',${idx})">Remove</button></div>`); };
    window.updateOptionValue = (base,i,val)=>{ const radios=document.querySelectorAll(`input[name="${base}Answer"][type="radio"]`); if(radios[i]) radios[i].value = val; };
    window.removeOption = (base,i)=>{ const list=$('#'+base+'OptionsList'); const opts=list.querySelectorAll('.option-input'); if(opts.length>2 && opts[i]) opts[i].remove(); };

    function collectQuizData(prefix){ const id=$(`#${prefix}quizId`)?.value?.trim() || $(`#${prefix}editQuizId`)?.value?.trim() || $('#editQuizId')?.value?.trim(); const title=$(`#${prefix}quizTitle`)?.value?.trim() || $('#editQuizTitle')?.value?.trim() || ''; const otp=($(`#${prefix}quizOTP`)?.value||$(`#${prefix}editQuizOTP`)?.value||'').trim(); const desc=$(`#${prefix}quizDescription`)?.value?.trim() || $('#editQuizDescription')?.value?.trim() || ''; const list = document.querySelectorAll(`#${prefix}questionsList .question-item, #editQuestionsList .question-item`); const questions=[]; list.forEach(el=>{ const qid=el.dataset.questionId; const base = (prefix?prefix:'')+qid; const type = el.querySelector('select')?.value||'multiple_choice'; const text = $(`#${base}Text`)?.value?.trim()||''; const explanation = $(`#${base}Explanation`)?.value?.trim()||''; let answer=''; let options=null; if(type==='multiple_choice'){ const checked = el.querySelector(`input[name="${base}Answer"]:checked`); answer = checked?checked.value:''; options = Array.from(el.querySelectorAll('.option-input input[type="text"]')).map(i=>i.value.trim()).filter(Boolean); } else if(type==='true_false'){ const checked = el.querySelector(`input[name="${base}Answer"]:checked`); answer = checked ? (checked.value==='true') : false; } else { const ans = $(`#${base}Answer`)?.value?.trim()||''; answer = ans.includes('|')?ans.split('|').map(s=>s.trim()):ans; } if(text){ const q={ id:qid, type, text, answer, explanation }; if(options) q.options=options; questions.push(q); } }); return { test_id:id, title, otp, description:desc, questions } }

    async function handleCreateQuiz(e){ e.preventDefault(); try{ const q = collectQuizData(''); if(!q.test_id||!q.title) throw new Error('Quiz ID and Title are required'); if(quizzes.find(x=>x.test_id===q.test_id)) throw new Error('A quiz with this ID already exists'); if(!q.questions.length) throw new Error('At least one question is required'); if(q.otp && !isValidOTP(q.otp)) throw new Error('OTP must be exactly 6 digits'); if(q.otp && quizzes.some(x=>(x.otp||'')===q.otp)) throw new Error('That OTP is already assigned to another quiz'); await saveQuizData(q); quizzes.push(q); renderQuizList(); clearQuizForm(); showQuizMessage('Quiz created successfully!','success'); document.querySelector('.quiz-tab[data-tab="list"]').click(); }catch(err){ showQuizMessage(err.message||'Create failed','error'); } }

    async function handleEditQuiz(e){ e.preventDefault(); try{ const q = collectQuizData('edit'); const originalId = $('#editQuizOriginalId').value; if(!q.test_id||!q.title) throw new Error('Quiz ID and Title are required'); if(!q.questions.length) throw new Error('At least one question is required'); if(originalId!==q.test_id && quizzes.find(x=>x.test_id===q.test_id)) throw new Error('A quiz with this ID already exists'); if(q.otp && !isValidOTP(q.otp)) throw new Error('OTP must be exactly 6 digits'); if(q.otp){ const conflict = quizzes.find(x=>x.test_id!==originalId && (x.otp||'')===q.otp); if(conflict) throw new Error('That OTP is already assigned to another quiz'); } await updateQuizData(originalId,q); const i = quizzes.findIndex(x=>x.test_id===originalId); if(i===-1) throw new Error('Original quiz not found'); quizzes[i]=q; renderQuizList(); closeEditQuizModal(); showQuizMessage('Quiz updated!','success'); }catch(err){ showQuizMessage(err.message||'Update failed','error'); } }

    /* ===== OTPs ===== */
    function generateRandomOTP(){ return Math.floor(100000 + Math.random()*900000).toString(); }
    window.generateOTP = ()=> $('#quizOTP').value = generateRandomOTP();
    window.generateEditOTP = ()=> $('#editQuizOTP').value = generateRandomOTP();
    window.generateNewOTP = ()=> $('#newOTPCode').value = generateRandomOTP();

    async function refreshOTPs(){ if(!otps.length){ otps=[ {code:'123456',quiz_id:'quiz_test',title:'Cohort A',status:'active',created_at:new Date().toISOString(),used_count:5}, {code:'789012',quiz_id:'ops_mastery',title:'Cohort B',status:'active',created_at:new Date().toISOString(),used_count:12} ]; } renderOTPList(); }
    function renderOTPList(){ const c=$('#otpListContainer'); if(!otps.length){ c.innerHTML='<div class="meta">No OTPs. Create one.</div>'; return; } c.innerHTML = otps.map(o=>`<div class="otp-item"><div class="otp-header"><div><div class="otp-code">${o.code}</div><div style="margin-top:4px"><strong>${o.title}</strong> <span class="meta">• Quiz: ${o.quiz_id} • Used: ${o.used_count}</span></div></div><div style="display:flex;gap:8px;align-items:center"><span class="otp-status ${o.status}">${o.status.toUpperCase()}</span><button class="secondary" onclick="editOTP('${o.code}')">Edit</button><button class="danger" onclick="deleteOTP('${o.code}')">Delete</button></div></div><div class="meta">Created: ${fmtUS(o.created_at)}</div></div>`).join(''); }

    window.showCreateOTPModal = ()=>{ const sel=$('#newOTPQuiz'); sel.innerHTML='<option value="">Select a quiz…</option>'; quizzes.forEach(q=>{ const op=document.createElement('option'); op.value=q.test_id; op.textContent=`${q.title} (${q.test_id})`; sel.appendChild(op); }); toggleOTPModal(true); };
    window.closeCreateOTPModal = ()=>{ toggleOTPModal(false); $('#createOTPForm').reset(); };
    function toggleOTPModal(on){ const m=$('#createOTPModal'); m.style.display=on?'flex':'none'; m.setAttribute('aria-hidden', on?'false':'true'); }

    async function handleCreateOTP(e){ e.preventDefault(); try{ const code=$('#newOTPCode').value.trim(); const quiz_id=$('#newOTPQuiz').value; const title=$('#newOTPTitle').value.trim(); if(!isValidOTP(code)) throw new Error('OTP must be 6 digits'); if(!quiz_id) throw new Error('Select a quiz'); if(otps.find(x=>x.code===code) || quizzes.some(q=>(q.otp||'')===code)) throw new Error('OTP already exists'); otps.push({ code, quiz_id, title: title||`Access for ${quiz_id}`, status:'active', created_at:new Date().toISOString(), used_count:0 }); // also attach to quiz
      const q = quizzes.find(q=>q.test_id===quiz_id); if(q) q.otp = code; renderOTPList(); renderQuizList(); toggleOTPModal(false); showQuizMessage('OTP created','success'); }catch(err){ showQuizMessage(err.message||'OTP failed','error'); } }

    window.editOTP = (code)=> alert('Edit OTP UI not implemented in this minimal build');
    window.deleteOTP = (code)=>{ if(!confirm('Delete OTP '+code+'?')) return; const i=otps.findIndex(x=>x.code===code); if(i>-1){ const quiz = quizzes.find(q=>q.otp===code); if(quiz) quiz.otp=''; otps.splice(i,1); renderOTPList(); renderQuizList(); showQuizMessage('OTP deleted','success'); } };

    /* ===== Edit / Duplicate / Delete ===== */
    window.editQuiz = (id)=>{ const q = quizzes.find(x=>x.test_id===id); if(!q) return showQuizMessage('Quiz not found','error'); editingQuiz=q; $('#editQuizOriginalId').value=q.test_id; $('#editQuizId').value=q.test_id; $('#editQuizTitle').value=q.title||''; $('#editQuizOTP').value=q.otp||''; $('#editQuizDescription').value=q.description||''; const list=$('#editQuestionsList'); list.innerHTML=''; (q.questions||[]).forEach((que,idx)=>{ const html = createQuestionHTML(que.id || ('q'+(idx+1)),'edit',que); list.insertAdjacentHTML('beforeend', html); }); toggleEditModal(true); };
    function toggleEditModal(on){ const m=$('#editQuizModal'); m.style.display=on?'flex':'none'; m.setAttribute('aria-hidden', on?'false':'true'); }
    window.closeEditQuizModal = ()=> toggleEditModal(false);

    window.duplicateQuiz = (id)=>{ const src = quizzes.find(x=>x.test_id===id); if(!src) return showQuizMessage('Quiz not found','error'); const dup = JSON.parse(JSON.stringify(src)); let base = src.test_id+'_copy', cand=base, n=2; while(quizzes.some(x=>x.test_id===cand)) cand = base+(n++); dup.test_id=cand; dup.title = (src.title||'Untitled')+' (Copy)'; dup.otp=''; // NEVER copy the OTP
      // preload create form
      $('#quizId').value=dup.test_id; $('#quizTitle').value=dup.title; $('#quizOTP').value=''; $('#quizDescription').value=dup.description||''; $('#questionsList').innerHTML=''; questionCounter=0; (dup.questions||[]).forEach(q=>{ questionCounter++; $('#questionsList').insertAdjacentHTML('beforeend', createQuestionHTML('q'+questionCounter,'',q)); }); showCreateTab(); showQuizMessage('Quiz duplicated — update ID/title as needed.','success'); };

    window.deleteQuiz = (id)=>{ if(!confirm('Delete quiz '+id+'?')) return; const i=quizzes.findIndex(x=>x.test_id===id); if(i>-1){ const otp=quizzes[i].otp; if(otp){ const oi=otps.findIndex(o=>o.code===otp); if(oi>-1) otps.splice(oi,1); } quizzes.splice(i,1); renderQuizList(); showQuizMessage('Quiz deleted','success'); } };

    window.clearQuizForm = ()=>{ $('#quizId').value=''; $('#quizTitle').value=''; $('#quizOTP').value=''; $('#quizDescription').value=''; $('#questionsList').innerHTML=''; questionCounter=0; };

    /* ===== Persistence (works with or without backend) ===== */
    async function saveQuizData(q){
      try{
        const res = await fetch('/api/admin/quizzes', { method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(q) });
        if(res.ok) return (await res.json()).quiz || q;
      }catch(_){}
      return q; // fallback for static demo
    }
    async function updateQuizData(originalId,q){
      try{
        const res = await fetch('/api/admin/quizzes/'+encodeURIComponent(originalId), { method:'PUT', headers:{'content-type':'application/json'}, body:JSON.stringify(q) });
        if(res.ok) return (await res.json()).quiz || q;
      }catch(_){}
      return q; // fallback
    }

    /* ===== Wire up ===== */
    $('#loadBtn')?.addEventListener('click', ()=>{ load(1); updateTokenStatus(); });
    $('#prevBtn')?.addEventListener('click', ()=>{ if(STATE.page>1) load(STATE.page-1); });
    $('#nextBtn')?.addEventListener('click', ()=>{ if(STATE.page<STATE.totalPages) load(STATE.page+1); });
    $('#closeModal')?.addEventListener('click', ()=> showModal(false));
    $('#exportBtn')?.addEventListener('click', exportAllCSV);
    $('#exportPageBtn')?.addEventListener('click', exportAllCSV);
    $('#saveSettingsBtn')?.addEventListener('click', ()=>{ const v=parseInt($('#settingsPass').value||'80',10); STATE.passThresholdPct = Math.max(1,Math.min(100,isFinite(v)?v:80)); $('#saveSettingsStatus').textContent='Saved ✓'; setTimeout(()=>$('#saveSettingsStatus').textContent=' ',1500); });
    $('#clearTokenBtn')?.addEventListener('click', ()=>{ $('#adminToken').value=''; STATE.tokenValid=false; clearMenu(); updateTokenStatus(); });

    function updateTokenStatus(){ const v=($('#adminToken')?.value||'').trim(); $('#tokenStatus').textContent = 'Token: ' + (v?('*'.repeat(Math.min(8,v.length))+'…'):'not set'); }

    async function exportAllCSV(){ const btn = this; const prev=btn.textContent; btn.textContent='Exporting…'; btn.disabled=true; try{ const header=['date','user','score','total','title']; const lines=[header.join(',')]; (STATE.lastResults||[]).forEach(a=>{ lines.push([a.received_at||'', a.user_name||'', a.scorePct||'', `${a.correct||''}/${a.total||''}`, a.title||''].map(csvEscape).join(',')); }); const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'}); const name='quiz_export_'+new Date().toISOString().slice(0,10)+'.csv'; const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); } finally { btn.textContent=prev; btn.disabled=false; } }

    // init
    document.addEventListener('DOMContentLoaded', ()=>{ clearMenu(); updateTokenStatus(); load(1); });
  })();
  </script>
</body>
</html>
